# Quest Keeper AI - Session Handoff Prompt
**Date:** December 3, 2024
**Session Focus:** Backend party management complete, ready for frontend integration

---

## Quick Context

Quest Keeper AI is a Tauri desktop RPG companion combining an AI Dungeon Master with a visual game engine. Architecture follows "LLM describes, engine validates" - all game state flows through validated MCP tool calls.

**Tech Stack:**
- Frontend: React 19 + TypeScript + Vite + Zustand + Three.js + TailwindCSS
- Backend: rpg-mcp server (Node.js binary via pkg, 80+ MCP tools, SQLite)
- Desktop: Tauri 2.x with sidecar process spawning
- Protocol: MCP (Model Context Protocol) via JSON-RPC over stdio

---

## What Was Completed This Session

### 1. Party Management System (Backend) ✅ COMPLETE

Added 13 new MCP tools to rpg-mcp:

| Tool | Purpose |
|------|---------|
| `create_party` | Create new party with optional initial members |
| `get_party` | Get party with embedded member character data |
| `list_parties` | List all parties, filter by status/world |
| `update_party` | Update party name, location, formation, status |
| `delete_party` | Delete party (members become unassigned) |
| `add_party_member` | Add character to party with role |
| `remove_party_member` | Remove character from party |
| `update_party_member` | Change role, position, notes |
| `set_party_leader` | Set party leader (demotes existing) |
| `set_active_character` | Set player's POV character |
| `get_party_members` | Get all members with details |
| `get_party_context` | LLM-optimized context (minimal/standard/detailed) |
| `get_unassigned_characters` | Characters not in any party |

### 2. Database Schema Updates ✅ COMPLETE

```sql
-- New tables
CREATE TABLE parties (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  description TEXT,
  world_id TEXT REFERENCES worlds(id),
  status TEXT DEFAULT 'active' CHECK (status IN ('active', 'dormant', 'archived')),
  current_location TEXT,
  current_quest_id TEXT REFERENCES quests(id),
  formation TEXT DEFAULT 'standard',
  created_at, updated_at, last_played_at
);

CREATE TABLE party_members (
  id TEXT PRIMARY KEY,
  party_id TEXT NOT NULL REFERENCES parties(id),
  character_id TEXT NOT NULL REFERENCES characters(id),
  role TEXT DEFAULT 'member' CHECK (role IN ('leader', 'member', 'companion', 'hireling', 'prisoner', 'mount')),
  is_active INTEGER DEFAULT 0,
  position INTEGER,
  share_percentage INTEGER DEFAULT 100,
  joined_at TEXT,
  notes TEXT,
  UNIQUE(party_id, character_id)
);

-- Added to characters table
ALTER TABLE characters ADD COLUMN character_type TEXT DEFAULT 'pc' 
  CHECK (character_type IN ('pc', 'npc', 'enemy', 'neutral'));
```

### 3. Build System Fixes ✅ COMPLETE

**Problem:** `better_sqlite3.node` was compiled for Node.js v22 (MODULE_VERSION 127) but `pkg` bundles Node.js v20 (MODULE_VERSION 115).

**Solution:** Updated `esbuild.config.mjs` to download prebuilt binaries from GitHub for Node.js v20 instead of copying from local node_modules.

**Problem:** Migration tried to create index on `character_type` column before the `ALTER TABLE` added it.

**Solution:** Reorganized `migrations.ts` to run ALTER TABLE migrations before creating dependent indexes.

### 4. Files Deployed

| Source | Destination |
|--------|-------------|
| `rpg-mcp/bin/rpg-mcp-win.exe` | `QuestKeeperAI-v2/src-tauri/binaries/rpg-mcp-server-x86_64-pc-windows-msvc.exe` |
| `rpg-mcp/bin/rpg-mcp-win.exe` | `QuestKeeperAI-v2/src-tauri/target/debug/rpg-mcp-server.exe` |
| `rpg-mcp/bin/better_sqlite3.node` | `QuestKeeperAI-v2/src-tauri/binaries/better_sqlite3.node` |
| `rpg-mcp/bin/better_sqlite3.node` | `QuestKeeperAI-v2/src-tauri/target/debug/better_sqlite3.node` |
| `src-tauri/rpg.db` | `src-tauri/target/debug/rpg.db` |

### 5. Git Status

**rpg-mcp** (branch: `feature/grand-strategy-dlc`):
```
commit 6959e45
feat: Add party management system and fix native module builds
10 files changed, 2560 insertions(+), 95 deletions(-)
```

**QuestKeeperAI-v2** (branch: `main`):
```
commit 6ef10a8
chore: Update rpg-mcp binary with party management and migration fixes
4 files changed, 493 insertions(+), 6 deletions(-)
```

---

## What Needs To Be Done (Frontend)

### 1. Create partyStore.ts
**Location:** `src/stores/partyStore.ts`

```typescript
interface PartyState {
  // State
  activePartyId: string | null;
  parties: Party[];
  partyDetails: Record<string, PartyWithMembers>; // Cached full party data
  
  // Loading
  isLoading: boolean;
  isSyncing: boolean;
  
  // Actions
  setActiveParty: (partyId: string | null) => void;
  createParty: (name: string, description?: string, worldId?: string, members?: { characterId: string; role?: string }[]) => Promise<string>;
  updateParty: (partyId: string, updates: Partial<Party>) => Promise<void>;
  deleteParty: (partyId: string) => Promise<void>;
  
  // Membership
  addMember: (partyId: string, characterId: string, role?: string) => Promise<void>;
  removeMember: (partyId: string, characterId: string) => Promise<void>;
  setLeader: (partyId: string, characterId: string) => Promise<void>;
  setActiveCharacter: (partyId: string, characterId: string) => Promise<void>;
  
  // Sync
  syncParties: () => Promise<void>;
  syncPartyDetails: (partyId: string) => Promise<void>;
  
  // Selectors
  getActiveParty: () => PartyWithMembers | null;
  getLeader: () => PartyMemberWithCharacter | null;
  getActiveCharacter: () => PartyMemberWithCharacter | null;
}
```

### 2. Create UI Components

**PartySelector.tsx** (header dropdown):
- Shows active party name
- Dropdown to switch parties
- Create new party button

**PartyPanel.tsx** (sidebar or viewport tab):
- Leader with crown icon
- Active character highlighted
- Member list with HP bars
- Formation selector
- Add/remove member buttons

**PartyCreatorModal.tsx**:
- Name, description fields
- World selector
- Character picker for initial members
- Role assignment

**CharacterPickerModal.tsx**:
- Shows unassigned characters
- Filter by character_type (pc/npc/enemy)
- Select role when adding

### 3. Update Existing Components

**AdventureView.tsx:**
- Replace character selector with party selector
- Use `get_party_context` for LLM context
- Show party status in QuickStats panel

**gameStateStore.ts:**
- Remove `activeCharacter` and `party` state (now in partyStore)
- Update `syncState()` to work with party context
- Keep `characters` as raw character lookup

### 4. Update LLM System Prompt
Include focused party context (~400 tokens instead of ~3000):
```typescript
const context = await mcpManager.gameStateClient.callTool('get_party_context', {
  partyId: activePartyId,
  verbosity: 'standard'
});
```

---

## Key Design Decisions

### Party as First-Class Entity
```
WORLD
├── Party: "Fellowship" (ACTIVE)
│   ├── Leader: Gandalf
│   ├── Active POV: Frodo ◆
│   └── Members: 9 total
└── Unassigned Characters
    ├── Balrog (enemy)
    └── Test characters
```

### Member Roles
| Role | In Combat? | Shares Loot? |
|------|------------|--------------|
| leader | Yes | Yes |
| member | Yes | Yes |
| companion | Yes | No |
| hireling | Optional | No |
| prisoner | No | No |
| mount | N/A | No |

### Character Types
- `pc` - Player characters
- `npc` - Non-player characters  
- `enemy` - Hostile creatures
- `neutral` - Non-hostile, non-ally

---

## Testing the Backend

Party tools are verified working. Test commands:

```typescript
// Create a party
await callTool('create_party', {
  name: 'The Fellowship',
  description: 'Nine companions',
  initialMembers: [
    { characterId: 'gandalf-id', role: 'leader' },
    { characterId: 'frodo-id', role: 'member' }
  ]
});

// Get party with members
await callTool('get_party', { partyId: '...' });

// Set active character
await callTool('set_active_character', {
  partyId: '...',
  characterId: 'frodo-id'
});

// Get LLM context
await callTool('get_party_context', {
  partyId: '...',
  verbosity: 'standard'  // 'minimal' | 'standard' | 'detailed'
});

// Get unassigned characters
await callTool('get_unassigned_characters', {});
```

---

## File Locations

### Backend (COMPLETE)
```
C:\Users\Vario\OneDrive\Desktop\MCP Servers\rpg-mcp\
├── src/server/party-tools.ts      # 13 party tools + handlers
├── src/schema/party.ts            # Zod schemas
├── src/storage/repos/party.repo.ts # Repository with CRUD
├── src/storage/migrations.ts      # Fixed migration order
├── esbuild.config.mjs             # Fixed Node.js v20 prebuilds
└── bin/
    ├── rpg-mcp-win.exe            # 43.27 MB
    ├── rpg-mcp-macos              # 50.42 MB
    ├── rpg-mcp-linux              # 56.53 MB
    ├── better_sqlite3.node        # 1.81 MB (Windows/default)
    ├── better_sqlite3-macos.node  # 1.82 MB
    └── better_sqlite3-linux.node  # 1.99 MB
```

### Frontend (TODO)
```
C:\Users\Vario\OneDrive\Desktop\QuestKeeperAI-v2\
├── src/stores/partyStore.ts           # CREATE
├── src/components/party/              # CREATE folder
│   ├── PartySelector.tsx
│   ├── PartyPanel.tsx
│   ├── PartyCreatorModal.tsx
│   └── CharacterPickerModal.tsx
├── src/components/adventure/
│   └── AdventureView.tsx              # UPDATE
└── src-tauri/binaries/
    ├── rpg-mcp-server-x86_64-pc-windows-msvc.exe  # DEPLOYED
    └── better_sqlite3.node                         # DEPLOYED
```

### Database
```
C:\Users\Vario\OneDrive\Desktop\QuestKeeperAI-v2\src-tauri\
├── rpg.db                    # 20MB - main database (seed)
└── target/debug/rpg.db       # Copy for dev runtime
```

---

## Current Database State

- **15 characters** (Fellowship + test characters), all with `characterType: 'pc'`
- **0 parties** (none created yet)
- **1 world** with generated tiles
- Characters have inventory items, some have quests

---

## Success Criteria

- [ ] Can create a party from UI
- [ ] Can add/remove characters from party
- [ ] Can set leader and active character
- [ ] "Who's in our party?" returns ONLY party members (not all 15 characters)
- [ ] LLM receives focused party context (~400 tokens instead of ~3000)
- [ ] Can switch between multiple parties
- [ ] Unassigned characters clearly separated from party members

---

## Open Questions

1. Should `partyStore` be separate or merged into `gameStateStore`?
2. Where should PartyPanel live - new viewport tab or sidebar?
3. Should we auto-create a "Default Party" on first launch?
4. How to handle existing test data (15 characters, no parties)?

---

## Quick Start Commands

```bash
# Terminal 1: Frontend dev server
cd "C:\Users\Vario\OneDrive\Desktop\QuestKeeperAI-v2"
npm run tauri dev

# If you need to rebuild backend:
cd "C:\Users\Vario\OneDrive\Desktop\MCP Servers\rpg-mcp"
npm run build:binaries
copy bin\rpg-mcp-win.exe "..\..\..\Desktop\QuestKeeperAI-v2\src-tauri\binaries\rpg-mcp-server-x86_64-pc-windows-msvc.exe"
copy bin\better_sqlite3.node "..\..\..\Desktop\QuestKeeperAI-v2\src-tauri\binaries\"
```

---

## Related Documentation

- `/mnt/project/RPG-MCP-Backend-Review.md` - Full backend analysis
- `/mnt/project/Quest-Keeper-AI-Frontend-Review.md` - Frontend review
- `/mnt/project/DEVELOPMENT_PLAN.md` - Roadmap and phases
- `/mnt/project/CODE_REVIEW_COMPREHENSIVE.md` - Code quality assessment
- `PARTY_MANAGEMENT_HANDOFF.md` in QuestKeeperAI-v2 repo

---

## Summary

**Backend: 100% complete** - Party management system with 13 MCP tools, database schema, and fixed build system.

**Frontend: 0% complete** - Need to create partyStore, UI components, and integrate with AdventureView.

**Next step:** Create `src/stores/partyStore.ts` and basic `PartySelector.tsx` component.
